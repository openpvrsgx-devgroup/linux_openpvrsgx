#!/bin/bash
#
# start PVR SGX GPU
# and run some demo
#
# usage: gpu-demo
#
# WARNING: this loads and installs packages with NON-FREE
# firmware for the SGX libraries and runtime support from
#
# http://download.goldelico.com/letux-debian-rootfs/debian/dists/jessie/main/binary-armhf/omap3-pvrsgx530-gta04_0.20130811195126_armhf.deb
#
# It needs a kernel where the GPL'ed SGX kernel driver is
# properly configured.
#

if egrep -q ti,omap3 </proc/device-tree/compatible
then
	MODEL=omap3
elif egrep -q ti,omap4 </proc/device-tree/compatible
then
	MODEL=omap4
elif egrep -q ti,omap5 </proc/device-tree/compatible
then
	MODEL=omap5
else
	echo "unsupported device: $(cat /sys/firmware/devicetree/base/model)"
	exit 1
fi

# autodetect package version to load
# FIXME: different location on omap5
PACKAGE=$(egrep -ao '[a-z0-9]*-sgx[0-9]*-[0-9]*' </proc/device-tree/ocp*/*g*x@*/compatible)	# match gfx@ and sgx@
COMPATIBLE=omap_$(echo "$PACKAGE" | tr '-' '_')
MODULE=pvr_$COMPATIBLE
echo autodetected driver package: $PACKAGE
echo compatible driver: $COMPATIBLE
echo module name: $MODULE

case "$MODEL" in
	*omap3* )
# FIXME: how can we decide betweeen the DDK 1.9 and the DDK 1.14 driver to load the correct package?
if false
then
		PACKAGE=omap3-pvrsgx530-gta04	# version detection does not work and we don't have separate pvrsgx-121 / pvrsgx-125 packages
else
		PACKAGE=omap3-pvrsgx-1.14
		PATH=/usr/local/omap3-pvrsgx/bin:$PATH
		export LD_LIBRARY_PATH=/usr/local/omap3-pvrsgx/lib
		ldconfig
fi
		;;
	*omap4* )
		PACKAGE=omap4-pvrsgx-1.14
		PATH=/usr/local/omap4-pvrsgx/bin:$PATH
		export LD_LIBRARY_PATH=/usr/local/omap4-pvrsgx/lib
		ldconfig
		;;
	*omap5* )
		PACKAGE=omap5-pvrsgx-1.14
		PATH=/usr/local/omap5-pvrsgx/bin:$PATH
		export LD_LIBRARY_PATH=/usr/local/omap5-pvrsgx/lib
		ldconfig
		;;
esac

# fetch the microkernel binary and libraries
[ "$(which pvrsrvctl)" ] || apt-get install -y --force-yes $PACKAGE

# if kernel module was blacklisted, load it now
lsmod | fgrep -q pvr_ || modprobe $MODULE

# fix clock setup
# should have been done by driver, hwmods and pdata-quirks
if fgrep -q AM33XX </proc/cpuinfo
then
	: seems to work now with CM_GFX_L3_CLKSTCTRL / CM_GFX_GFX_CLKCTRL hack
	# devmem2 0x44E00900 w 0x02
	# devmem2 0x44E00904 w 0x02
	# devmem2 0x44E0090c w 0x02
	# devmem2 0x44E00910 w 0x02
	# devmem2 0x44E00914 w 0x02
else
	: no fix needed
fi

# start pvr
fgrep -q 'System Version String: None' /proc/pvr/version && pvrsrvctl --start --no-module

fgrep "System Version String: " /proc/pvr/version

for i in sgx_clipblit_test gles1test1 gles2test1 eglinfo kmscube
do
	if [ "$(which $i)" ]
	then
		echo Running $i
		timeout 10 $i
	fi
done

# pvrsrvctl --stop
